<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#2d7a3e">
    <meta name="description" content="国道ステッカー取得記録アプリ">
    
    <!-- Apple 用メタタグ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ステッカー記録">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%232d7a3e' width='180' height='180' rx='45'/><text x='50%' y='50%' font-size='90' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'>🛣️</text></svg>">
    
    <title>国道ステッカー記録</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- App CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%232d7a3e' width='192' height='192'/><text x='50%' y='50%' font-size='100' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='middle'>🚗</text></svg>">
</head>
<body>
    <div id="app">
        <!-- ウェルカムスクリーン -->
        <div v-if="!initialized" class="welcome-screen">
            <div class="welcome-container">
                <div class="welcome-icon">🛣️</div>
                <h1 class="welcome-title">国道ステッカー</h1>
                <p class="welcome-subtitle">日本全国の国道ステッカーを記録しよう</p>
                
                <div class="welcome-features">
                    <div class="feature-item">
                        <span class="feature-icon">📝</span>
                        <span class="feature-text">ステッカー取得を記録</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">🗺️</span>
                        <span class="feature-text">取得地点を地図表示</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">📸</span>
                        <span class="feature-text">写真を保存</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">☁️</span>
                        <span class="feature-text">データをバックアップ</span>
                    </div>
                </div>

                <button 
                    type="button"
                    @click.prevent="startApp" 
                    class="btn btn-primary btn-large">
                    はじめる →
                </button>

                <p class="welcome-footer">オフライン対応・データはあなたのスマートフォンに保存されます</p>
            </div>
        </div>

        <!-- ナビゲーション -->
        <nav v-else class="navbar">
            <div class="navbar-brand">
                <span class="logo">🛣️ 国道ステッカー</span>
            </div>
            <div class="nav-tabs">
                <button 
                    class="tab-btn" 
                    :class="{ active: currentTab === 'add' }"
                    @click="currentTab = 'add'">
                    追加
                </button>
                <button 
                    class="tab-btn" 
                    :class="{ active: currentTab === 'list' }"
                    @click="currentTab = 'list'">
                    リスト ({{ stickers.length }})
                </button>
                <button 
                    class="tab-btn" 
                    :class="{ active: currentTab === 'map' }"
                    @click="currentTab = 'map'">
                    地図
                </button>
                <button 
                    class="tab-btn" 
                    :class="{ active: currentTab === 'menu' }"
                    @click="currentTab = 'menu'">
                    ⚙️
                </button>
            </div>
        </nav>

        <!-- 追加パネル -->
        <div v-if="currentTab === 'add'" class="panel add-panel">
            <h2>新しいステッカーを記録</h2>
            
            <form @submit.prevent="addSticker" class="form">
                <div class="form-group">
                    <label>国道番号 *</label>
                    <input 
                        v-model="form.roadNumber" 
                        type="number" 
                        min="1" 
                        max="999"
                        placeholder="例: 4"
                        required>
                </div>

                <div class="form-group">
                    <label>取得日 *</label>
                    <input 
                        v-model="form.date" 
                        type="date"
                        required>
                </div>

                <div class="form-group">
                    <label>施設名・建物名</label>
                    <div class="location-input-group">
                        <input 
                            v-model="form.location" 
                            type="text"
                            placeholder="例: 東京駅、京都駅、スカイツリー"
                            @blur="geocodeLocation">
                        <button 
                            v-if="form.location && !geocoding"
                            type="button" 
                            @click="geocodeLocation"
                            class="btn btn-secondary btn-small"
                            title="施設から座標を取得">
                            🔍
                        </button>
                        <span v-if="geocoding" class="geocoding-spinner">⏳</span>
                    </div>
                    <p v-if="geocodingError" class="error-message">{{ geocodingError }}</p>
                </div>

                <div class="form-group">
                    <label>緯度</label>
                    <input 
                        v-model.number="form.latitude" 
                        type="number"
                        step="0.000001"
                        placeholder="例: 40.604">
                </div>

                <div class="form-group">
                    <label>経度</label>
                    <input 
                        v-model.number="form.longitude" 
                        type="number"
                        step="0.000001"
                        placeholder="例: 140.6235">
                </div>

                <div class="form-group">
                    <label>写真</label>
                    <input 
                        type="file" 
                        accept="image/*"
                        @change="handleImageUpload"
                        class="file-input">
                    <div v-if="form.image" class="image-preview">
                        <img :src="form.image" alt="プレビュー">
                        <button type="button" @click="form.image = null" class="remove-btn">削除</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>メモ</label>
                    <textarea 
                        v-model="form.memo"
                        placeholder="その他の情報を入力..."
                        rows="3"></textarea>
                </div>

                <button type="submit" class="btn btn-primary">記録する</button>
            </form>
        </div>

        <!-- リストパネル -->
        <div v-if="currentTab === 'list'" class="panel list-panel">
            <h2>記録済みステッカー一覧</h2>
            
            <div v-if="stickers.length === 0" class="empty-state">
                <p>まだステッカーが記録されていません</p>
            </div>

            <div v-else class="filters">
                <input 
                    v-model="searchQuery"
                    type="text"
                    placeholder="国道番号で検索..."
                    class="search-input">
            </div>

            <div class="sticker-list">
                <div 
                    v-for="sticker in filteredStickers" 
                    :key="sticker.id"
                    class="sticker-card">
                    
                    <div class="card-header">
                        <h3>国道 {{ sticker.roadNumber }} 号</h3>
                        <button @click="deleteSticker(sticker.id)" class="delete-btn">×</button>
                    </div>

                    <div class="card-body">
                        <p><strong>取得日:</strong> {{ formatDate(sticker.date) }}</p>
                        <p v-if="sticker.location"><strong>場所:</strong> {{ sticker.location }}</p>
                        
                        <div v-if="sticker.image" class="card-image">
                            <img :src="sticker.image" :alt="'国道' + sticker.roadNumber">
                        </div>

                        <p v-if="sticker.memo" class="memo">{{ sticker.memo }}</p>

                        <button 
                            v-if="sticker.latitude && sticker.longitude"
                            @click="goToMap(sticker)"
                            class="btn btn-secondary">
                            地図で表示
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 地図パネル -->
        <div v-if="currentTab === 'map'" class="panel map-panel">
            <h2>ステッカー取得地点</h2>
            <div id="map" class="map-container"></div>
            
            <div v-if="selectedMapMarker" class="map-info">
                <h4>国道 {{ selectedMapMarker.roadNumber }} 号</h4>
                <p>{{ formatDate(selectedMapMarker.date) }}</p>
                <p v-if="selectedMapMarker.location">{{ selectedMapMarker.location }}</p>
            </div>
        </div>

        <!-- メニューパネル -->
        <div v-if="currentTab === 'menu'" class="panel menu-panel">
            <h2>メニュー</h2>
            
            <div class="menu-section">
                <h3>ホーム画面に追加</h3>
                <p class="menu-desc">iPhone でホーム画面に追加するとアプリのように使えます</p>
                <button @click="showInstallPrompt" class="btn btn-primary menu-btn">
                    📱 ホーム画面に追加
                </button>
                <p class="menu-hint">Safari の共有 → "ホーム画面に追加" をタップ</p>
            </div>

            <div class="menu-section">
                <h3>データのバックアップ</h3>
                <button @click="exportData" class="btn btn-secondary menu-btn">
                    📤 エクスポート
                </button>
                <p class="menu-hint">すべてのステッカーデータを JSON ファイルで保存</p>
            </div>

            <div class="menu-section">
                <h3>データの復元</h3>
                <input 
                    type="file" 
                    accept=".json"
                    @change="importData"
                    class="file-input menu-input"
                    id="import-file">
                <label for="import-file" class="btn btn-secondary menu-btn" style="display: block; text-align: center;">
                    📥 インポート
                </label>
                <p class="menu-hint">バックアップファイルを選択して復元</p>
            </div>

            <div class="menu-section info-section">
                <h3>情報</h3>
                <p><strong>記録数:</strong> {{ stickers.length }} 件</p>
                <p><strong>バージョン:</strong> 1.0.0</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="app.js"></script>
</body>
</html>
